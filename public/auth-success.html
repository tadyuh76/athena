<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Đã Được Xác Thực - Athena</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">
    <script src="/js/components.js"></script>
</head>
<body style="padding-top: 80px;">
    <site-header></site-header>
    
    <div class="container d-flex align-items-center justify-content-center min-vh-100">
        <div class="text-center">
            <div id="loadingState">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <h5>Đang xác thực email của bạn...</h5>
                <p class="text-muted">Vui lòng đợi trong khi chúng tôi hoàn tất xác thực.</p>
            </div>
            
            <div id="successState" style="display: none;">
                <div class="mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 80px;"></i>
                </div>
                <h2 class="mb-3" style="font-family: 'Cormorant Garamond', serif;">Email Đã Được Xác Thực!</h2>
                <p class="text-muted mb-4">Email của bạn đã được xác thực thành công.</p>
                <a href="/login.html" class="btn btn-dark btn-lg">Đăng Nhập Vào Tài Khoản</a>
            </div>
            
            <div id="errorState" style="display: none;">
                <div class="mb-4">
                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 80px;"></i>
                </div>
                <h2 class="mb-3">Xác Thực Thất Bại</h2>
                <p class="text-muted mb-4" id="errorMessage">Không thể xác thực email của bạn. Liên kết có thể đã hết hạn.</p>
                <a href="/login.html" class="btn btn-dark">Quay Lại Đăng Nhập</a>
            </div>
        </div>
    </div>

    <site-footer></site-footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Initialize Supabase client
        const supabaseUrl = 'https://qvrehppbsvuordemsqrk.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2cmVocHBic3Z1b3JkZW1zcXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Njk3NjcsImV4cCI6MjA3NDM0NTc2N30.P3QbX0g7LGTmvDlY8CbV-vSTsPyS-ph5gC4cXujB2kg';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        async function handleEmailVerification() {
            const loadingState = document.getElementById('loadingState');
            const successState = document.getElementById('successState');
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                // Get hash parameters (Supabase returns tokens in hash)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const type = hashParams.get('type');
                
                // Also check URL params for token
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token') || accessToken;
                
                if (!token) {
                    // Check if there's an error in URL
                    const error = hashParams.get('error_description') || urlParams.get('error');
                    throw new Error(error || 'No authentication token found');
                }
                
                // If we have a token, the email is verified
                // Get the current user session
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    throw error;
                }
                
                if (user) {
                    console.log('User verified:', user.email);
                    
                    // Create/update user profile in our database
                    const response = await fetch('/api/auth/oauth-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            email: user.email,
                            metadata: {
                                email_verified: true,
                                ...user.user_metadata
                            }
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Store auth info
                        if (result.token) {
                            localStorage.setItem('authToken', result.token);
                        }
                        if (result.user) {
                            localStorage.setItem('user', JSON.stringify(result.user));
                        }
                        
                        // Show success state
                        loadingState.style.display = 'none';
                        successState.style.display = 'block';
                        
                        // Auto redirect to home after 3 seconds
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 3000);
                    } else {
                        throw new Error(result.error || 'Failed to update profile');
                    }
                } else {
                    throw new Error('No user data found');
                }
            } catch (error) {
                console.error('Verification error:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                errorMessage.textContent = error.message || 'Không thể xác thực email của bạn. Liên kết có thể đã hết hạn.';
            }
        }

        // Handle verification on page load
        handleEmailVerification();
    </script>
</body>
</html>