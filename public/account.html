<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tài Khoản - Athena</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="css/index.css" rel="stylesheet" />
    <link href="css/account.css" rel="stylesheet" />
    <script src="/js/components.js"></script>
  </head>
  <body>
    <!-- Navigation -->
    <site-header></site-header>

    <!-- Account Content -->
    <div class="container py-5">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
          <div class="account-sidebar">
            <ul class="account-menu">
              <li>
                <a href="#profile" class="active" data-section="profile">
                  <i class="bi bi-person"></i>
                  Hồ Sơ
                </a>
              </li>
              <li>
                <a href="#orders" data-section="orders">
                  <i class="bi bi-bag"></i>
                  Đơn Hàng
                </a>
              </li>
              <li>
                <a href="#addresses" data-section="addresses">
                  <i class="bi bi-geo-alt"></i>
                  Địa Chỉ
                </a>
              </li>
              <li>
                <a href="#security" data-section="security">
                  <i class="bi bi-shield-lock"></i>
                  Bảo Mật
                </a>
              </li>
              <li>
                <a href="#" id="logoutBtn">
                  <i class="bi bi-box-arrow-right"></i>
                  Đăng Xuất
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
          <!-- Profile Section -->
          <div id="profileSection" class="account-content">
            <h3 class="mb-4" style="font-family: 'Cormorant Garamond', serif">
              Hồ Sơ Của Tôi
            </h3>

            <div class="row align-items-center mb-4">
              <div class="col-auto">
                <img
                  src="/images/placeholder-user.jpg"
                  alt="Hồ sơ"
                  class="profile-avatar"
                  id="profileAvatar"
                />
              </div>
              <div class="col">
                <h5 id="profileName">Đang tải...</h5>
                <p class="text-muted mb-0" id="profileEmail">Đang tải...</p>
                <small class="text-muted"
                  >Thành viên từ <span id="memberSince">-</span></small
                >
              </div>
            </div>

            <hr class="my-4" />

            <form id="profileForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="firstName" class="form-label">Họ</label>
                  <input
                    type="text"
                    class="form-control"
                    id="firstName"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="lastName" class="form-label">Tên</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lastName"
                    required
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label">Địa Chỉ Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    disabled
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="phone" class="form-label">Số Điện Thoại</label>
                  <input type="tel" class="form-control" id="phone" />
                </div>
              </div>

              <div class="mb-3">
                <label for="birthDate" class="form-label">Ngày Sinh</label>
                <input type="date" class="form-control" id="birthDate" />
              </div>

              <button type="submit" class="btn btn-dark">Lưu Thay Đổi</button>
            </form>
          </div>

          <!-- Orders Section -->
          <div id="ordersSection" class="account-content" style="display: none">
            <h3 class="mb-4" style="font-family: 'Cormorant Garamond', serif">
              Đơn Hàng Của Tôi
            </h3>

            <div id="ordersList">
              <!-- Orders will be loaded here -->
            </div>

            <div id="noOrders" class="text-center py-5" style="display: none">
              <i class="bi bi-bag fs-1 text-muted mb-3"></i>
              <p class="text-muted">Bạn chưa có đơn hàng nào.</p>
              <a href="/products.html" class="btn btn-dark">Bắt Đầu Mua Sắm</a>
            </div>
          </div>

          <!-- Addresses Section -->
          <div
            id="addressesSection"
            class="account-content"
            style="display: none"
          >
            <h3 class="mb-4" style="font-family: 'Cormorant Garamond', serif">
              Địa Chỉ Giao Hàng
            </h3>

            <button class="btn btn-outline-dark mb-4" id="addAddressBtn">
              <i class="bi bi-plus-circle me-2"></i>Thêm Địa Chỉ Mới
            </button>

            <div id="addressesList">
              <!-- Addresses will be loaded here -->
            </div>

            <div
              id="noAddresses"
              class="text-center py-5"
              style="display: none"
            >
              <i class="bi bi-geo-alt fs-1 text-muted mb-3"></i>
              <p class="text-muted">Chưa có địa chỉ nào được lưu.</p>
            </div>
          </div>

          <!-- Security Section -->
          <div
            id="securitySection"
            class="account-content"
            style="display: none"
          >
            <h3 class="mb-4" style="font-family: 'Cormorant Garamond', serif">
              Cài Đặt Bảo Mật
            </h3>

            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title">Đổi Mật Khẩu</h5>
                <form id="passwordForm">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label"
                      >Mật Khẩu Hiện Tại</label
                    >
                    <input
                      type="password"
                      class="form-control"
                      id="currentPassword"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="newPassword" class="form-label"
                      >Mật Khẩu Mới</label
                    >
                    <input
                      type="password"
                      class="form-control"
                      id="newPassword"
                      required
                      minlength="8"
                    />
                    <div class="form-text">Tối thiểu 8 ký tự</div>
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label"
                      >Xác Nhận Mật Khẩu Mới</label
                    >
                    <input
                      type="password"
                      class="form-control"
                      id="confirmPassword"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-dark">
                    Cập Nhật Mật Khẩu
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <site-footer></site-footer>

    <!-- Toast Container -->
    <div
      class="toast-container position-fixed bottom-0 end-0 p-3"
      id="toastContainer"
    ></div>

    <!-- Address Modal -->
    <div
      class="modal fade"
      id="addressModal"
      tabindex="-1"
      aria-labelledby="addressModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addressModalLabel">Thêm Địa Chỉ Mới</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addressForm">
              <input type="hidden" id="addressId" />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="addrFirstName" class="form-label">Họ *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="addrFirstName"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="addrLastName" class="form-label">Tên *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="addrLastName"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="addrPhone" class="form-label"
                  >Số Điện Thoại *</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="addrPhone"
                  required
                  placeholder="0901234567"
                />
                <div class="form-text">
                  Nhập số điện thoại để liên hệ giao hàng
                </div>
              </div>
              <div class="mb-3">
                <label for="addrCompany" class="form-label"
                  >Công Ty (tùy chọn)</label
                >
                <input type="text" class="form-control" id="addrCompany" />
              </div>
              <div class="mb-3">
                <label for="addrLine1" class="form-label"
                  >Số Nhà, Tên Đường *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="addrLine1"
                  required
                  placeholder="VD: 123 Nguyễn Huệ"
                />
              </div>
              <div class="mb-3">
                <label for="addrLine2" class="form-label"
                  >Căn hộ, Tầng, Tòa nhà (tùy chọn)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="addrLine2"
                  placeholder="VD: Tầng 5, Căn 502"
                />
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="addrCity" class="form-label">Phường/Xã *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="addrCity"
                    required
                    placeholder="VD: Phường Bến Nghé"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="addrState" class="form-label">Quận/Huyện *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="addrState"
                    required
                    placeholder="VD: Quận 1"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="addrCountry" class="form-label"
                    >Tỉnh/Thành phố *</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="addrCountry"
                    required
                    placeholder="VD: Hồ Chí Minh"
                  />
                </div>
              </div>
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="addrIsDefault"
                />
                <label class="form-check-label" for="addrIsDefault">
                  Đặt làm địa chỉ giao hàng mặc định
                </label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button type="button" class="btn btn-dark" id="saveAddressBtn">
              Lưu Địa Chỉ
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/navbar.js"></script>
    <script type="module">
      import { AuthService } from "/services/AuthService.js";
      import { AddressService } from "/services/AddressService.js";
      import { Dialog } from "/js/dialog.js";

      const authService = new AuthService();
      const addressService = new AddressService();
      let currentUser = null;
      let addressModal = null;

      // Check authentication
      async function checkAuth() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        if (!user.id) {
          window.location.href = "/login.html?redirect=/account.html";
          return;
        }
        currentUser = user;
        loadProfile();
      }

      // Load profile data
      function loadProfile() {
        if (!currentUser) return;

        // Update profile display
        document.getElementById("profileName").textContent =
          `${currentUser.first_name || ""} ${
            currentUser.last_name || ""
          }`.trim() || "Người dùng";
        document.getElementById("profileEmail").textContent = currentUser.email;

        // Update avatar
        const avatarUrl =
          currentUser.avatar_url ||
          currentUser.metadata?.picture ||
          "/images/placeholder-user.jpg";
        document.getElementById("profileAvatar").src = avatarUrl;

        // Member since
        if (currentUser.created_at) {
          const date = new Date(currentUser.created_at);
          document.getElementById("memberSince").textContent =
            date.toLocaleDateString("en-US", {
              month: "long",
              year: "numeric",
            });
        }

        // Fill form
        document.getElementById("firstName").value =
          currentUser.first_name || "";
        document.getElementById("lastName").value = currentUser.last_name || "";
        document.getElementById("email").value = currentUser.email || "";
        document.getElementById("phone").value = currentUser.phone || "";

        if (currentUser.metadata?.birth_date) {
          document.getElementById("birthDate").value =
            currentUser.metadata.birth_date;
        }
      }

      // Handle section navigation
      document
        .querySelectorAll(".account-menu a[data-section]")
        .forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const section = link.dataset.section;

            // Update active menu
            document
              .querySelectorAll(".account-menu a")
              .forEach((a) => a.classList.remove("active"));
            link.classList.add("active");

            // Show selected section
            document
              .querySelectorAll('[id$="Section"]')
              .forEach((sec) => (sec.style.display = "none"));
            document.getElementById(section + "Section").style.display =
              "block";

            // Load section data
            if (section === "orders") {
              loadOrders();
            } else if (section === "addresses") {
              loadAddresses();
            }
          });
        });

      // Handle profile form submission
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const updates = {
            first_name: document.getElementById("firstName").value,
            last_name: document.getElementById("lastName").value,
            phone: document.getElementById("phone").value,
            metadata: {
              ...currentUser.metadata,
              birth_date: document.getElementById("birthDate").value,
            },
          };

          try {
            const response = await fetch("/api/auth/me", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("authToken")}`,
              },
              body: JSON.stringify(updates),
            });

            const result = await response.json();
            if (result.success) {
              currentUser = { ...currentUser, ...updates };
              localStorage.setItem("user", JSON.stringify(currentUser));
              showToast("Cập nhật hồ sơ thành công!", "success");
              loadProfile();
            } else {
              showToast("Không thể cập nhật hồ sơ", "danger");
            }
          } catch (error) {
            showToast("Đã xảy ra lỗi", "danger");
          }
        });

      // Handle password form submission
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showToast("Mật khẩu không khớp", "danger");
            return;
          }

          // TODO: Implement password change
          showToast("Chức năng đổi mật khẩu đang được phát triển", "info");
        });

      // Handle logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await authService.logout();
        });

      // Load orders
      async function loadOrders() {
        const ordersList = document.getElementById("ordersList");
        const noOrders = document.getElementById("noOrders");

        // Show loading
        ordersList.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            `;

        try {
          const apiUrl =
            (window.ENV ? window.ENV.getApiUrl() : "/api") + "/orders/me";
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("authToken")}`,
            },
          });

          const data = await response.json();

          if (data.success && data.orders && data.orders.length > 0) {
            ordersList.innerHTML = data.orders
              .map((order) => {
                // Render product items
                const productItems =
                  order.items && order.items.length > 0
                    ? order.items
                        .map((item) => {
                          const variantInfo = [];
                          if (item.variant_size)
                            variantInfo.push(`Size: ${item.variant_size}`);
                          if (item.variant_color)
                            variantInfo.push(`Màu: ${item.variant_color}`);
                          const variantText =
                            variantInfo.length > 0
                              ? ` (${variantInfo.join(", ")})`
                              : "";
                          // Prioritize variant image over product image
                          const imageUrl = item.variant_image_url || item.product_image_url || '/images/placeholder.jpg';
                          return `
                            <div class="d-flex align-items-center mb-2">
                              <img src="${imageUrl}"
                                   alt="${item.product_name}"
                                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 12px;">
                              <div class="small text-muted">
                                <div>${item.product_name}${variantText}</div>
                                <div class="fw-semibold">×${item.quantity}</div>
                              </div>
                            </div>`;
                        })
                        .join("")
                    : '<div class="small text-muted">Không có sản phẩm</div>';

                return `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="mb-1">${
                                              order.order_number
                                            }</h5>
                                            <small class="text-muted">Đặt ngày ${new Date(
                                              order.created_at
                                            ).toLocaleDateString(
                                              "vi-VN"
                                            )}</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold text-success">$${order.total_amount.toFixed(
                                              2
                                            )}</div>
                                            <span class="badge ${getStatusBadgeClass(
                                              order.status
                                            )}">${getStatusText(
                  order.status
                )}</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted fw-semibold">Sản phẩm:</small>
                                        <div class="mt-1">${productItems}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-4 mb-2">
                                            <small class="text-muted">Trạng thái thanh toán</small><br>
                                            <span class="badge ${getPaymentStatusBadgeClass(
                                              order.payment_status
                                            )}">${getPaymentStatusText(
                  order.payment_status
                )}</span>
                                        </div>
                                        <div class="col-sm-4 mb-2">
                                            <small class="text-muted">Email</small><br>
                                            <span>${order.customer_email}</span>
                                        </div>
                                        <div class="col-sm-4 mb-2">
                                            <small class="text-muted">Phương thức vận chuyển</small><br>
                                            <span>${
                                              order.shipping_method ||
                                              "Standard"
                                            }</span>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <a href="/order-confirmation.html?order_id=${
                                          order.id
                                        }" class="btn btn-sm btn-outline-dark">
                                            <i class="bi bi-eye me-1"></i>Xem Chi Tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
              })
              .join("");
            noOrders.style.display = "none";
          } else {
            ordersList.innerHTML = "";
            noOrders.style.display = "block";
          }
        } catch (error) {
          console.error("Failed to load orders:", error);
          ordersList.innerHTML =
            '<div class="alert alert-danger">Không thể tải đơn hàng. Vui lòng thử lại.</div>';
          noOrders.style.display = "none";
        }
      }

      // Get status badge class
      function getStatusBadgeClass(status) {
        const classes = {
          pending: "bg-warning",
          preparing: "bg-info",
          shipping: "bg-primary",
          delivered: "bg-success",
          cancelled: "bg-danger",
          refunded: "bg-secondary",
        };
        return classes[status] || "bg-secondary";
      }

      // Get status text
      function getStatusText(status) {
        const texts = {
          pending: "Đang Chờ",
          preparing: "Đang Chuẩn Bị",
          shipping: "Đang Giao",
          delivered: "Đã Giao",
          cancelled: "Đã Hủy",
          refunded: "Đã Hoàn Tiền",
        };
        return texts[status] || status;
      }

      // Get payment status badge class
      function getPaymentStatusBadgeClass(status) {
        const classes = {
          pending: "bg-warning",
          paid: "bg-success",
          failed: "bg-danger",
          refunded: "bg-info",
        };
        return classes[status] || "bg-secondary";
      }

      // Get payment status text
      function getPaymentStatusText(status) {
        const texts = {
          pending: "Đang Chờ",
          paid: "Đã Thanh Toán",
          failed: "Thất Bại",
          refunded: "Đã Hoàn Tiền",
        };
        return texts[status] || status;
      }

      // Load addresses
      async function loadAddresses() {
        const addressesList = document.getElementById("addressesList");
        const noAddresses = document.getElementById("noAddresses");

        try {
          const addresses = await addressService.getAddresses();

          if (addresses.length === 0) {
            addressesList.innerHTML = "";
            noAddresses.style.display = "block";
            return;
          }

          noAddresses.style.display = "none";
          addressesList.innerHTML = addresses
            .map(
              (address) => `
                    <div class="card mb-3" data-address-id="${address.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">
                                        ${address.first_name} ${
                address.last_name
              }
                                        ${
                                          address.is_default
                                            ? '<span class="badge bg-success ms-2">Mặc định</span>'
                                            : ""
                                        }
                                    </h5>
                                    <p class="mb-1"><i class="bi bi-telephone me-1"></i>${
                                      address.phone
                                    }</p>
                                    ${
                                      address.company
                                        ? `<p class="mb-1 text-muted">${address.company}</p>`
                                        : ""
                                    }
                                    <p class="mb-1">${address.address_line1}</p>
                                    ${
                                      address.address_line2
                                        ? `<p class="mb-1 text-muted">${address.address_line2}</p>`
                                        : ""
                                    }
                                    <p class="mb-0">${address.city}, ${
                address.state_province
              }, ${address.country_code}</p>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item edit-address-btn" href="#" data-address-id="${
                                          address.id
                                        }">
                                            <i class="bi bi-pencil me-2"></i>Chỉnh Sửa
                                        </a></li>
                                        ${
                                          !address.is_default
                                            ? `
                                            <li><a class="dropdown-item set-default-btn" href="#" data-address-id="${address.id}">
                                                <i class="bi bi-star me-2"></i>Đặt Làm Mặc Định
                                            </a></li>
                                        `
                                            : ""
                                        }
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-address-btn" href="#" data-address-id="${
                                          address.id
                                        }">
                                            <i class="bi bi-trash me-2"></i>Xóa
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".edit-address-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.preventDefault();
              const addressId = e.currentTarget.getAttribute("data-address-id");
              editAddress(addressId);
            });
          });

          document.querySelectorAll(".set-default-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.preventDefault();
              const addressId = e.currentTarget.getAttribute("data-address-id");
              await setDefaultAddress(addressId);
            });
          });

          document.querySelectorAll(".delete-address-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.preventDefault();
              const addressId = e.currentTarget.getAttribute("data-address-id");
              await deleteAddress(addressId);
            });
          });
        } catch (error) {
          console.error("Failed to load addresses:", error);
          showToast("Không thể tải địa chỉ", "danger");
        }
      }

      // Open address modal for adding new address
      function openAddressModal() {
        document.getElementById("addressModalLabel").textContent =
          "Thêm Địa Chỉ Mới";
        document.getElementById("addressForm").reset();
        document.getElementById("addressId").value = "";
        addressModal.show();
      }

      // Edit address
      async function editAddress(addressId) {
        try {
          const address = await addressService.getAddressById(addressId);

          document.getElementById("addressModalLabel").textContent =
            "Chỉnh Sửa Địa Chỉ";
          document.getElementById("addressId").value = address.id;
          document.getElementById("addrFirstName").value = address.first_name;
          document.getElementById("addrLastName").value = address.last_name;
          document.getElementById("addrCompany").value = address.company || "";
          document.getElementById("addrLine1").value = address.address_line1;
          document.getElementById("addrLine2").value =
            address.address_line2 || "";
          document.getElementById("addrCity").value = address.city;
          document.getElementById("addrState").value =
            address.state_province || "";
          document.getElementById("addrCountry").value = address.country_code;
          document.getElementById("addrPhone").value = address.phone || "";
          document.getElementById("addrIsDefault").checked = address.is_default;

          addressModal.show();
        } catch (error) {
          console.error("Failed to load address:", error);
          showToast("Không thể tải địa chỉ", "danger");
        }
      }

      // Save address (create or update)
      async function saveAddress() {
        const form = document.getElementById("addressForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const addressId = document.getElementById("addressId").value;
        const addressData = {
          first_name: document.getElementById("addrFirstName").value.trim(),
          last_name: document.getElementById("addrLastName").value.trim(),
          phone: document.getElementById("addrPhone").value.trim(),
          company:
            document.getElementById("addrCompany").value.trim() || undefined,
          address_line1: document.getElementById("addrLine1").value.trim(), // Số nhà + Tên đường
          address_line2:
            document.getElementById("addrLine2").value.trim() || undefined, // Căn hộ, tầng
          city: document.getElementById("addrCity").value.trim(), // Phường/Xã
          state_province: document.getElementById("addrState").value.trim(), // Quận/Huyện
          country_code: document.getElementById("addrCountry").value.trim(), // Tỉnh/Thành phố
          type: "shipping", // All addresses are shipping addresses
          is_default: document.getElementById("addrIsDefault").checked,
        };

        try {
          if (addressId) {
            await addressService.updateAddress(addressId, addressData);
            showToast("Đã cập nhật địa chỉ thành công", "success");
          } else {
            await addressService.createAddress(addressData);
            showToast("Đã thêm địa chỉ mới thành công", "success");
          }

          addressModal.hide();
          await loadAddresses();
        } catch (error) {
          console.error("Failed to save address:", error);
          showToast(error.message || "Không thể lưu địa chỉ", "danger");
        }
      }

      // Set address as default
      async function setDefaultAddress(addressId) {
        try {
          await addressService.setDefaultAddress(addressId);
          showToast("Đã đặt địa chỉ mặc định", "success");
          await loadAddresses();
        } catch (error) {
          console.error("Failed to set default address:", error);
          showToast("Không thể đặt địa chỉ mặc định", "danger");
        }
      }

      // Delete address
      async function deleteAddress(addressId) {
        const confirmed = await Dialog.confirm(
          "Bạn có chắc chắn muốn xóa địa chỉ này?",
          {
            confirmText: "Xóa",
            confirmColor: "danger",
          }
        );

        if (!confirmed) return;

        try {
          await addressService.deleteAddress(addressId);
          showToast("Đã xóa địa chỉ", "success");
          await loadAddresses();
        } catch (error) {
          console.error("Failed to delete address:", error);
          showToast(error.message || "Không thể xóa địa chỉ", "danger");
        }
      }

      // Show toast notification
      function showToast(message, type = "info") {
        const toastContainer = document.getElementById("toastContainer");
        const toastId = "toast-" + Date.now();

        const toast = document.createElement("div");
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute("role", "alert");
        toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener("hidden.bs.toast", () => {
          toast.remove();
        });
      }

      // Initialize on load
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize address modal
        addressModal = new bootstrap.Modal(
          document.getElementById("addressModal")
        );

        // Add address button event listener
        document
          .getElementById("addAddressBtn")
          .addEventListener("click", openAddressModal);

        // Save address button event listener
        document
          .getElementById("saveAddressBtn")
          .addEventListener("click", saveAddress);
      });

      checkAuth();
    </script>
  </body>
</html>
